function handleTaskClick(taskId) {
    if (!checkVpnRequirement()) return;

    const task = tasks[taskId];
    const taskButton = document.getElementById(`taskBtn_${taskId}`);
    if (taskButton.disabled) return;

    taskButton.disabled = true;

    const clickCounterRule = appSettings.clickCounterRule || 10;
    const clicksToday = currentUser.taskStats?.clicksToday || 0;
    if (clicksToday > 0 && clicksToday % clickCounterRule === 0) {
        tg.showAlert(`This is click #${clicksToday + 1}. Please interact with the ad.`);
    }
    database.ref(`users/${currentUser.id}/taskStats/clicksToday`).set(firebase.database.ServerValue.increment(1));

    let adPromise;
    try {
        switch(task.network) {
            case 'Monetag': adPromise = window.show_9797628(); break;
            case 'Gigapub': adPromise = window.showGiga(); break;
            case 'Adexora': adPromise = window.showAdexora(); break;
            case 'AdeExtra': adPromise = new Promise(resolve => setTimeout(resolve, 5000)); break;
            default: adPromise = Promise.reject('Unknown network');
        }
        // যদি adPromise একটি ভ্যালিড Promise না হয় (যেমন SDK ফাংশন मौजूद না থাকলে), তাহলে এটি একটি ত্রুটি দেবে।
        if (!adPromise || typeof adPromise.then !== 'function') {
            throw new Error("SDK function did not return a valid promise.");
        }
    } catch (e) {
        adPromise = Promise.reject('SDK error: ' + e.message);
    }

    // --- নতুন টাইমআউট ব্যবস্থা ---
    const TIMEOUT_DURATION = 20000; // ২০ সেকেন্ড
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => {
            reject(new Error('AdTimeout'));
        }, TIMEOUT_DURATION);
    });

    // Promise.race বিজ্ঞাপন বা টাইমআউটের মধ্যে যেটি আগে হবে, সেটিকে গ্রহণ করবে
    Promise.race([adPromise, timeoutPromise])
        .then(() => {
            // বিজ্ঞাপন সফল হলে এই অংশ কাজ করবে
            const rewardBTD = task.rewardBTD || 0;
            if (rewardBTD > 0) {
                const btdToUsdRate = appSettings.btdToUsdRate || 0.01;
                const rewardUSD = rewardBTD * btdToUsdRate;

                const updates = {};
                updates[`/users/${currentUser.id}/btdBalance`] = firebase.database.ServerValue.increment(rewardBTD);
                updates[`/users/${currentUser.id}/usdBalance`] = firebase.database.ServerValue.increment(rewardUSD);
                updates[`/leaderboards/btd/${currentUser.id}`] = firebase.database.ServerValue.increment(rewardBTD);
                database.ref().update(updates);
                showToast(`+${rewardBTD.toFixed(2)} BTD (+${rewardUSD.toFixed(2)} USD)!`);
            }

            // পুরস্কার দেওয়ার পর টাইমার শুরু হবে
            let timerSeconds = task.timer || 0;
            if (timerSeconds > 0) {
                let currentTimer = timerSeconds;
                taskButton.textContent = `Wait ${currentTimer}s`;

                taskTimers[taskId] = setInterval(() => {
                    currentTimer--;
                    if (currentTimer > 0) {
                        taskButton.textContent = `Wait ${currentTimer}s`;
                    } else {
                        clearInterval(taskTimers[taskId]);
                        taskButton.disabled = false;
                        taskButton.textContent = 'Start Task';
                        delete taskTimers[taskId];
                    }
                }, 1000);
            } else {
                taskButton.disabled = false;
            }
        })
        .catch(err => {
            // বিজ্ঞাপন ব্যর্থ হলে বা টাইমআউট হলে এই অংশ কাজ করবে
            if (err && err.message === 'AdTimeout') {
                showToast("বিজ্ঞাপন লোড হতে দেরি হচ্ছে। আবার চেষ্টা করুন।");
            } else {
                showToast("বিজ্ঞাপন দেখাতে ব্যর্থ। আবার চেষ্টা করুন।");
            }

            // বাটনটিকে আবার আগের অবস্থায় ফিরিয়ে আনা
            if (taskTimers[taskId]) {
                clearInterval(taskTimers[taskId]);
            }
            taskButton.disabled = false;
            taskButton.textContent = 'Start Task';
            delete taskTimers[taskId];
        });
}
