<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (Head section is unchanged) ... -->
</head>
<body>
    <!-- ... (Loader and app container are unchanged) ... -->
    <div class="app-container" style="display: none;">
        <!-- ... (Header, profile section are unchanged) ... -->
        <div class="content-section" id="mainContent"></div>
        <div class="bottom-nav disabled" id="bottomNav">
            <!-- ... (Nav items are unchanged) ... -->
        </div>

        <!-- Ad Modal -->
        <div class="ad-modal-overlay" id="adModal"><div class="ad-modal"><h3 class="ad-modal-title" id="adModalTitle">Loading Ad...</h3><div class="spinner"></div></div></div>
        
        <!-- ADDED: Countdown Modal -->
        <div class="ad-modal-overlay" id="countdownModal">
            <div class="ad-modal">
                <h3 class="ad-modal-title">Verification Required</h3>
                <p>Please return to this screen after interacting with the ad.</p>
                <p style="font-size: 1.5rem; font-weight: 700; margin: 15px 0;">
                    Reward in: <span id="countdownTimer">--</span>
                </p>
                <p style="font-size: 0.8rem; color: var(--text-secondary);">You will be rewarded automatically when the timer ends.</p>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ... (Firebase initialization and other functions up to handleTaskClick are unchanged) ...

        let countdownInterval; // Global variable for the timer

        function handleTaskClick(taskId) {
            const task = tasks[taskId];
            const clicksToday = currentUser.taskStats?.clicksToday || 0;
            const nextClickNumber = clicksToday + 1;

            // NEW LOGIC: Check for forced click triggers
            const clickTriggersStr = appSettings.clickTriggers || "";
            const clickTriggers = clickTriggersStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            const isTriggerClick = clickTriggers.includes(nextClickNumber);

            // Increment the click counter in the database immediately
            database.ref(`users/${currentUser.id}/taskStats/clicksToday`).set(firebase.database.ServerValue.increment(1));

            if (isTriggerClick) {
                // --- FORCED CLICK FLOW ---
                const countdownDuration = appSettings.clickCountdown || 15;
                
                tg.showAlert(`This is a verification click (#${nextClickNumber}). You must interact with the ad. Your reward will be granted after a ${countdownDuration}-second countdown.`);
                
                // Start the ad
                try {
                    switch(task.network) {
                        case 'Monetag': window.show_9797628(); break;
                        case 'Gigapub': window.showGiga(); break;
                        case 'AdeExora': window.showAdexora(); break;
                        case 'AdeExtra': break; 
                    }
                } catch (e) { console.error('Ad SDK error:', e); }

                // Show countdown modal and start timer
                openCountdownModal(countdownDuration);
                let timer = countdownDuration;
                countdownInterval = setInterval(() => {
                    timer--;
                    document.getElementById('countdownTimer').textContent = timer;
                    if (timer <= 0) {
                        clearInterval(countdownInterval);
                        closeCountdownModal();
                        
                        // Grant reward after countdown finishes
                        const updates = {};
                        updates[`/users/${currentUser.id}/points`] = firebase.database.ServerValue.increment(task.reward);
                        updates[`/leaderboards/points/${currentUser.id}`] = firebase.database.ServerValue.increment(task.reward);
                        database.ref().update(updates);
                        showToast(`+${task.reward} Points! Verification complete.`);
                    }
                }, 1000);

            } else {
                // --- NORMAL CLICK FLOW ---
                openAdModal(`${task.network} Ad Playing...`);
                let adPromise;
                try {
                    switch(task.network) {
                        case 'Monetag': adPromise = window.show_9797628(); break;
                        case 'Gigapub': adPromise = window.showGiga(); break;
                        case 'AdeExora': adPromise = window.showAdexora(); break;
                        case 'AdeExtra': adPromise = new Promise(resolve => setTimeout(resolve, 5000)); break;
                        default: adPromise = Promise.reject('Unknown network');
                    }
                } catch (e) { adPromise = Promise.reject('SDK error'); }

                adPromise.then(() => {
                    closeAdModal();
                    const updates = {};
                    updates[`/users/${currentUser.id}/points`] = firebase.database.ServerValue.increment(task.reward);
                    updates[`/leaderboards/points/${currentUser.id}`] = firebase.database.ServerValue.increment(task.reward);
                    database.ref().update(updates);
                    showToast(`+${task.reward} Points!`);
                }).catch(err => {
                    closeAdModal();
                    showToast("Ad failed. Please try again.");
                });
            }
        }
        
        // ... (Other functions like handleBonusClaim, loadWithdrawHistory are unchanged) ...

        function openAdModal(title) { document.getElementById('adModalTitle').textContent = title; document.getElementById('adModal').classList.add('show'); }
        function closeAdModal() { document.getElementById('adModal').classList.remove('show'); }

        // ADDED: Helper functions for the new countdown modal
        function openCountdownModal(duration) {
            document.getElementById('countdownTimer').textContent = duration;
            document.getElementById('countdownModal').classList.add('show');
        }
        function closeCountdownModal() {
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('countdownModal').classList.remove('show');
        }
        
        function showToast(message, duration = 3000) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), duration); }
    </script>
</body>
</html>
