<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnZone - টেলিগ্রাম মিনি অ্যাপ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ad Networks SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9797628' data-sdk='show_9797628'></script>
    <script src="https://ad.gigapub.tech/script?id=2868"></script>
    <script src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Hind Siliguri', sans-serif;
            transition: all 0.3s ease;
        }
        
        body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        
        .card {
            background: rgba(26, 32, 44, 0.8);
            border: 1px solid #4a5568;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .nav-item.active {
            border-bottom: 3px solid #4299e1;
            transform: scale(1.05);
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .bonus-button {
            background: linear-gradient(45deg, #ecc94b, #ed8936);
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }
        
        .bonus-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background: rgba(74, 85, 104, 0.3);
        }
        
        .withdraw-method {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .withdraw-method:hover {
            border-color: #4299e1;
            transform: scale(1.02);
        }
        
        .loader {
            border: 3px solid #2d3748;
            border-radius: 50%;
            border-top: 3px solid #4299e1;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        input, select {
            background: rgba(26, 32, 44, 0.6);
            border: 1px solid #4a5568;
            color: #e2e8f0;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
        }
        
        .btn-primary {
            background: #4299e1;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        
        .scroll-notice {
            background: rgba(66, 153, 225, 0.15);
            border: 1px solid rgba(66, 153, 225, 0.3);
        }
        
        .page {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }
        
        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .task-timer {
            background: #2d3748;
            color: #ecc94b;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        
        .special-task {
            border: 2px solid #ecc94b;
            background: linear-gradient(135deg, rgba(236, 201, 75, 0.1), rgba(237, 137, 54, 0.1));
        }
        
        .vpn-required {
            border-left: 4px solid #f56565;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- টেলিগ্রাম লগইন সিস্টেম -->
    <div id="loginContainer" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="login-form p-6 rounded-lg w-90 max-w-sm mx-4 text-center">
            <h2 class="text-2xl font-bold mb-4 text-white">টেলিগ্রাম লগইন</h2>
            <p class="text-sm mb-6 text-gray-300">আপনার টেলিগ্রাম অ্যাকাউন্ট দিয়ে লগইন করুন</p>
            
            <!-- টেলিগ্রাম লগইন বাটন -->
            <script async src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="earn_zone_user_bot" 
                    data-size="large" 
                    data-auth-url="https://yourdomain.com/auth" 
                    data-request-access="write"></script>
            
            <p class="mt-4 text-xs text-gray-400">লগইন করলে আপনি আমাদের Terms এবং Privacy Policy accept করেন</p>
        </div>
    </div>

    <!-- মেইন অ্যাপ কন্টেন্ট -->
    <div id="appContent" class="hidden">
        <!-- হেডার with টেলিগ্রাম প্রোফাইল -->
        <div class="flex justify-between items-center p-4">
            <div class="flex items-center">
                <img id="userProfileImg" src="" class="w-12 h-12 rounded-full border-2 border-blue-400 mr-3">
                <div>
                    <h3 id="userName" class="font-bold"></h3>
                    <p class="text-xs">আইডি: <span id="userId"></span></p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-sm">রেফারেল কোড</p>
                <p class="font-bold" id="referralCode"></p>
            </div>
        </div>

        <!-- নোটিশ বার -->
        <div class="scroll-notice py-2 px-4 flex items-center mt-2 mx-4 rounded-lg">
            <i class="fas fa-bullhorn mr-2 text-blue-400"></i>
            <marquee behavior="scroll" direction="left" id="noticeBar">লোড হচ্ছে...</marquee>
        </div>

        <!-- পয়েন্ট ব্যালেন্স -->
        <div class="card p-4 mx-4 mt-4">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm opacity-80">মোট ব্যালেন্স</p>
                    <h2 class="text-2xl font-bold" id="userBalance">০ পয়েন্ট</h2>
                </div>
                <div class="bonus-button rounded-full p-3 cursor-pointer pulse" id="dailyBonusBtn">
                    <i class="fas fa-gift text-xl text-white"></i>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2">
                <div class="bg-gray-800 p-2 rounded-lg">
                    <p class="text-xs">আজকের ইনকাম</p>
                    <p class="font-bold" id="todayEarnings">০ পয়েন্ট</p>
                </div>
                <div class="bg-gray-800 p-2 rounded-lg">
                    <p class="text-xs">কমপ্লিট টাস্ক</p>
                    <p class="font-bold" id="completedTasks">০ টি</p>
                </div>
            </div>
        </div>

        <!-- ডেইলি বোনাস সেকশন -->
        <div class="card p-4 mx-4 mt-4">
            <h3 class="font-bold text-lg mb-2">ডেইলি বোনাস</h3>
            <p class="text-sm mb-3" id="bonusMessage">অ্যাড দেখে ডেইলি বোনাস নিন</p>
            <button class="bonus-button w-full py-3 rounded-lg font-bold text-white" id="claimBonusBtn">
                <span id="bonusAmount">০</span> পয়েন্ট নিন
            </button>
        </div>
        
        <!-- লিডারবোর্ড -->
        <div class="card p-4 mx-4 mt-4">
            <h3 class="font-bold text-lg mb-2">টপ আর্নার্স</h3>
            <div class="space-y-3" id="leaderboard">
                <p class="text-center py-4">লোড হচ্ছে...</p>
            </div>
        </div>

        <!-- নেভিগেশন মেনু -->
        <div class="flex justify-around items-center card p-2 mx-4 mt-4">
            <div class="nav-item text-center p-2 rounded-lg active" data-page="homePage">
                <i class="fas fa-home text-xl text-blue-400"></i>
                <p class="text-xs mt-1">হোম</p>
            </div>
            <div class="nav-item text-center p-2 rounded-lg" data-page="tasksPage">
                <i class="fas fa-tasks text-xl text-green-400"></i>
                <p class="text-xs mt-1">টাস্ক</p>
            </div>
            <div class="nav-item text-center p-2 rounded-lg" data-page="referralPage">
                <i class="fas fa-users text-xl text-purple-400"></i>
                <p class="text-xs mt-1">রেফারেল</p>
            </div>
            <div class="nav-item text-center p-2 rounded-lg" data-page="withdrawPage">
                <i class="fas fa-wallet text-xl text-yellow-400"></i>
                <p class="text-xs mt-1">উইথড্র</p>
            </div>
        </div>

        <!-- পেজ কন্টেন্ট -->
        <div class="mx-4 mt-4" id="pagesContainer">
            <!-- হোম পেজ -->
            <div id="homePage" class="page active">
                <!-- হোম পেজ কন্টেন্ট আগেই দেখানো হয়েছে -->
            </div>

            <!-- টাস্ক পেজ -->
            <div id="tasksPage" class="page">
                <h2 class="text-xl font-bold mb-4">সকল টাস্ক</h2>
                <div class="space-y-3" id="tasksList">
                    <p class="text-center py-4">টাস্ক লোড হচ্ছে...</p>
                </div>
            </div>

            <!-- রেফারেল পেজ -->
            <div id="referralPage" class="page">
                <div class="card p-4 mb-4 text-center">
                    <h2 class="text-xl font-bold mb-2">রেফারেল সিস্টেম</h2>
                    <p class="text-sm mb-4" id="referralMessage">বন্ধুকে রেফার করুন এবং পয়েন্ট বোনাস পান</p>
                    
                    <div class="bg-blue-500 bg-opacity-20 rounded-lg p-3 mb-4">
                        <p class="text-xs">আপনার রেফারেল লিংক</p>
                        <div class="flex items-center mt-2">
                            <input type="text" class="flex-grow bg-gray-800 border border-gray-700 rounded-l-lg p-2 text-xs" value="লোড হচ্ছে..." readonly id="referralLink">
                            <button class="bg-blue-600 py-2 px-3 rounded-r-lg" id="copyReferralBtn">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-gray-800 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold" id="totalReferrals">০</p>
                            <p class="text-xs">মোট রেফার</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold" id="activeReferrals">০</p>
                            <p class="text-xs">অ্যাক্টিভ</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold" id="referralPoints">০</p>
                            <p class="text-xs">পয়েন্ট</p>
                        </div>
                    </div>
                    
                    <button class="btn-primary w-full py-3 rounded-lg font-bold" onclick="shareOnTelegram()">
                        <i class="fab fa-telegram-plane"></i> টেলিগ্রামে শেয়ার করুন
                    </button>
                </div>
                
                <!-- রেফারেল লিডারবোর্ড -->
                <div class="card p-4">
                    <h3 class="font-bold text-lg mb-3">রেফারেল লিডারবোর্ড</h3>
                    <div class="space-y-3" id="referralLeaderboard">
                        <p class="text-center text-sm py-4">রেফারেল লিডারবোর্ড ডেটা লোড হচ্ছে...</p>
                    </div>
                </div>
            </div>

            <!-- উইথড্র পেজ -->
            <div id="withdrawPage" class="page">
                <div class="card p-4 mb-4">
                    <h2 class="text-xl font-bold mb-4">উইথড্র পয়েন্ট</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm mb-2">পয়েন্ট পরিমাণ</label>
                        <input type="number" class="w-full rounded-lg p-3" placeholder="উইথড্র করার পয়েন্ট লিখুন" id="withdrawAmount">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm mb-2">পেমেন্ট মেথড</label>
                        <div class="grid grid-cols-2 gap-3" id="paymentMethods">
                            <p class="text-center py-4">লোড হচ্ছে...</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm mb-2">অ্যাকাউন্ট নম্বর</label>
                        <input type="text" class="w-full rounded-lg p-3" placeholder="আপনার অ্যাকাউন্ট নম্বর লিখুন" id="accountNumber">
                    </div>
                    
                    <button class="bg-green-600 hover:bg-green-700 w-full py-3 rounded-lg font-bold" id="withdrawBtn">উইথড্র করুন</button>
                    
                    <div class="mt-4 text-xs bg-gray-800 rounded-lg p-3">
                        <p><i class="fas fa-info-circle"></i> ন্যূনতম উইথড্র: <span id="minWithdraw">500</span> পয়েন্ট</p>
                        <p><i class="fas fa-info-circle"></i> সর্বোচ্চ উইথড্র: <span id="maxWithdraw">10000</span> পয়েন্ট</p>
                        <p><i class="fas fa-info-circle"></i> উইথড্র Approve হতে ২৪-৪৮ ঘণ্টা সময় লাগতে পারে</p>
                    </div>
                </div>
                
                <!-- উইথড্র হিস্ট্রি -->
                <div class="card p-4">
                    <h3 class="font-bold text-lg mb-3">উইথড্র হিস্ট্রি</h3>
                    <div class="space-y-3" id="withdrawHistory">
                        <p class="text-center text-sm py-4">আপনার কোন উইথড্র হিস্ট্রি নেই</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- বটম নেভিগেশন বার -->
        <div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 flex justify-around items-center p-3">
            <div class="text-center text-blue-400 nav-bottom" data-page="homePage">
                <i class="fas fa-home text-xl"></i>
                <p class="text-xs mt-1">হোম</p>
            </div>
            <div class="text-center nav-bottom" data-page="tasksPage">
                <i class="fas fa-tasks text-xl text-gray-500"></i>
                <p class="text-xs mt-1 text-gray-500">টাস্ক</p>
            </div>
            <div class="text-center nav-bottom" data-page="referralPage">
                <i class="fas fa-users text-xl text-gray-500"></i>
                <p class="text-xs mt-1 text-gray-500">রেফারেল</p>
            </div>
            <div class="text-center nav-bottom" data-page="withdrawPage">
                <i class="fas fa-wallet text-xl text-gray-500"></i>
                <p class="text-xs mt-1 text-gray-500">উইথড্র</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCRnFOockStuQ6z3AU2dQ9fzZ6Tt_bUDL4",
            authDomain: "earn-zone-a6dce.firebaseapp.com",
            databaseURL: "https://earn-zone-a6dce-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "earn-zone-a6dce",
            storageBucket: "earn-zone-a6dce.firebasestorage.app",
            messagingSenderId: "470563695372",
            appId: "1:470563695372:web:323d2941c316cef0a4b729"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let userTaskStats = {};
        let adNetworks = {
            monetag: { zoneId: "9797628", loaded: false },
            gigapub: { zoneId: "2868", loaded: false },
            adexium: { widgetId: "ab02a033-a1a1-48b1-ad1a-525f7cde5c6f", loaded: false }
        };

        // ==================== TELEGRAM AUTHENTICATION ====================
        function initTelegramAuth() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                tg.ready();
                
                const user = tg.initDataUnsafe.user;
                if (user) {
                    processTelegramUser(user);
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('appContent').classList.remove('hidden');
                }
            } else {
                // Show login form if not in Telegram environment
                document.getElementById('loginContainer').classList.remove('hidden');
            }
        }

        // ==================== USER MANAGEMENT ====================
        async function processTelegramUser(user) {
            try {
                const userRef = db.collection('users').doc(user.id.toString());
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    // New user - welcome bonus
                    await userRef.set({
                        id: user.id,
                        first_name: user.first_name,
                        last_name: user.last_name || '',
                        username: user.username || '',
                        photo_url: user.photo_url || '',
                        points: 100, // Welcome bonus
                        todayEarnings: 0,
                        completedTasks: 0,
                        totalEarnings: 0,
                        totalWithdrawn: 0,
                        totalReferrals: 0,
                        activeReferrals: 0,
                        referralPoints: 0,
                        referralCode: generateReferralCode(),
                        taskAttempts: {},
                        specialTaskClicks: {},
                        createdAt: new Date(),
                        lastSeen: new Date(),
                        banned: false
                    });
                    alert('🎉 রেজিস্টার সফল! ১০০ পয়েন্ট বোনাস পেয়েছেন!');
                } else {
                    // Update last seen
                    await userRef.update({
                        last_seen: new Date()
                    });
                }
                
                currentUser = { uid: user.id.toString(), ...user };
                updateUserUI(user);
                loadUserData(user.id.toString());
                
            } catch (error) {
                console.error('User processing error:', error);
            }
        }

        function updateUserUI(user) {
            document.getElementById('userProfileImg').src = user.photo_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            document.getElementById('userName').textContent = `${user.first_name} ${user.last_name || ''}`;
            document.getElementById('userId').textContent = user.id;
        }

        // ==================== LOAD USER DATA ====================
        async function loadUserData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser.data = userData;
                    
                    // Update UI
                    document.getElementById('userBalance').textContent = `${userData.points || 0} পয়েন্ট`;
                    document.getElementById('todayEarnings').textContent = userData.todayEarnings || 0;
                    document.getElementById('completedTasks').textContent = userData.completedTasks || 0;
                    document.getElementById('referralCode').textContent = userData.referralCode || '';
                    
                    // Referral link
                    document.getElementById('referralLink').value = `https://t.me/earn_zone_user_bot?start=${userData.referralCode}`;
                    
                    // Load other data
                    loadAdminSettings();
                    loadTasks();
                    loadLeaderboard();
                    loadWithdrawMethods();
                    loadWithdrawHistory();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // ==================== ADMIN SETTINGS ====================
        async function loadAdminSettings() {
            try {
                // Load notices
                const noticeDoc = await db.collection('adminSettings').doc('notices').get();
                if (noticeDoc.exists) {
                    document.getElementById('noticeBar').innerHTML = noticeDoc.data().currentNotice || '🎉 নতুন ইউজারদের জন্য ১০০ পয়েন্ট বোনাস!';
                }

                // Load bonus settings
                const bonusDoc = await db.collection('adminSettings').doc('bonusSettings').get();
                if (bonusDoc.exists) {
                    const bonusData = bonusDoc.data();
                    document.getElementById('bonusAmount').textContent = bonusData.dailyBonus || 50;
                    document.getElementById('bonusMessage').textContent = bonusData.bonusMessage || 'অ্যাড দেখে ডেইলি বোনাস নিন';
                }

                // Load referral settings
                const referralDoc = await db.collection('adminSettings').doc('referralSettings').get();
                if (referralDoc.exists) {
                    document.getElementById('referralMessage').textContent = referralDoc.data().referralMessage || 'বন্ধুকে রেফার করুন এবং পয়েন্ট বোনাস পান';
                }

                // Load withdraw settings
                const withdrawDoc = await db.collection('adminSettings').doc('withdrawSettings').get();
                if (withdrawDoc.exists) {
                    const withdrawData = withdrawDoc.data();
                    document.getElementById('minWithdraw').textContent = withdrawData.minWithdraw || 500;
                    document.getElementById('maxWithdraw').textContent = withdrawData.maxWithdraw || 10000;
                }

            } catch (error) {
                console.error('Error loading admin settings:', error);
            }
        }

        // ==================== TASK MANAGEMENT ====================
        async function loadTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').where('enabled', '==', true).orderBy('order', 'asc').get();
                const tasksList = document.getElementById('tasksList');
                tasksList.innerHTML = '';
                
                if (tasksSnapshot.empty) {
                    tasksList.innerHTML = '<p class="text-center py-4">কোন টাস্ক পাওয়া যায়নি</p>';
                    return;
                }
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    const taskElement = createTaskElement(task, doc.id);
                    tasksList.appendChild(taskElement);
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function createTaskElement(task, taskId) {
            const taskElement = document.createElement('div');
            taskElement.className = `task-card card p-4 mb-3 ${task.requireVPN ? 'vpn-required' : ''} ${task.isSpecial ? 'special-task' : ''}`;
            
            taskElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-blue-300">${task.title}</h3>
                    <span class="bg-green-500 text-xs px-2 py-1 rounded">${task.points} পয়েন্ট</span>
                </div>
                <p class="text-sm mb-3">${task.description || 'টাস্কটি সম্পন্ন করুন এবং পয়েন্ট পান'}</p>
                <div class="flex justify-between items-center text-xs text-gray-400">
                    <span>${task.network || 'Monetag'} ${task.requireVPN ? '• VPN প্রয়োজন' : ''}</span>
                    <span id="taskStatus-${taskId}">লোড হচ্ছে...</span>
                </div>
                <button class="task-btn btn-primary w-full py-2 rounded mt-3" data-task-id="${taskId}">
                    শুরু করুন
                </button>
                <div class="task-timer" id="taskTimer-${taskId}"></div>
            `;
            
            // Check task status
            checkTaskStatus(taskId, task);
            
            return taskElement;
        }

        async function checkTaskStatus(taskId, task) {
            if (!currentUser) return;
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            const taskStats = userData.taskAttempts?.[taskId] || { dailyCount: 0, hourlyCount: 0, totalClicks: 0 };
            
            let statusMessage = 'শুরু করুন';
            let disabled = false;
            
            // Check daily limit
            if (taskStats.dailyCount >= task.dailyLimit) {
                statusMessage = 'আজকের লিমিট শেষ';
                disabled = true;
            }
            // Check hourly limit
            else if (taskStats.hourlyCount >= task.hourlyLimit) {
                statusMessage = 'ঘন্টায় লিমিট শেষ';
                disabled = true;
            }
            // Check special task requirements
            else if (task.isSpecial && taskStats.totalClicks < task.requiredClicks) {
                statusMessage = `${taskStats.totalClicks}/${task.requiredClicks} ক্লিক`;
                disabled = true;
            }
            
            document.getElementById(`taskStatus-${taskId}`).textContent = statusMessage;
            if (disabled) {
                document.querySelector(`[data-task-id="${taskId}"]`).disabled = true;
                document.querySelector(`[data-task-id="${taskId}"]`).classList.add('bg-gray-500');
            }
        }

        // ==================== TASK EXECUTION ====================
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('task-btn')) {
                const taskId = e.target.getAttribute('data-task-id');
                const taskDoc = await db.collection('tasks').doc(taskId).get();
                
                if (taskDoc.exists) {
                    const taskData = taskDoc.data();
                    await startTask(taskId, taskData);
                }
            }
        });

        async function startTask(taskId, taskData) {
            try {
                // Check VPN requirement
                if (taskData.requireVPN && !await checkVPN()) {
                    alert('এই টাস্কের জন্য VPN প্রয়োজন!');
                    return;
                }
                
                // Show ad
                const adSuccess = await showAd(taskData.network.toLowerCase());
                if (!adSuccess) {
                    alert('অ্যাড লোড করতে সমস্যা হয়েছে!');
                    return;
                }
                
                // Start task timer if duration is set
                if (taskData.duration > 0) {
                    startTaskTimer(taskId, taskData.duration);
                } else {
                    await completeTask(taskId, taskData);
                }
                
            } catch (error) {
                console.error('Task error:', error);
                alert('টাস্ক শুরু করতে সমস্যা হয়েছে!');
            }
        }

        async function showAd(network) {
            try {
                switch(network) {
                    case 'monetag':
                        if (typeof window.showMonetagAd === 'function') {
                            await window.showMonetagAd();
                            return true;
                        }
                        break;
                        
                    case 'gigapub':
                        if (typeof window.showGiga === 'function') {
                            await window.showGiga();
                            return true;
                        }
                        break;
                        
                    case 'adexium':
                        if (window.AdexiumWidget) {
                            const widget = new AdexiumWidget({
                                wid: 'ab02a033-a1a1-48b1-ad1a-525f7cde5c6f',
                                adFormat: 'interstitial'
                            });
                            widget.autoMode();
                            return true;
                        }
                        break;
                }
                return false;
            } catch (error) {
                console.error('Ad error:', error);
                return false;
            }
        }

        function startTaskTimer(taskId, duration) {
            const timerElement = document.getElementById(`taskTimer-${taskId}`);
            const taskBtn = document.querySelector(`[data-task-id="${taskId}"]`);
            
            let timeLeft = duration;
            timerElement.style.display = 'block';
            timerElement.innerHTML = `⏳ ${timeLeft} সেকেন্ড বাকি`;
            taskBtn.disabled = true;
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                timerElement.innerHTML = `⏳ ${timeLeft} সেকেন্ড বাকি`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    completeTask(taskId, taskData);
                }
            }, 1000);
        }

        async function completeTask(taskId, taskData) {
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                const userData = userDoc.data();
                
                const taskAttempts = userData.taskAttempts || {};
                const currentStats = taskAttempts[taskId] || { dailyCount: 0, hourlyCount: 0, totalClicks: 0, lastAttempt: null };
                
                // Update task stats
                const now = new Date();
                taskAttempts[taskId] = {
                    dailyCount: currentStats.dailyCount + 1,
                    hourlyCount: currentStats.hourlyCount + 1,
                    totalClicks: currentStats.totalClicks + 1,
                    lastAttempt: now
                };
                
                // Update user data
                await userRef.update({
                    points: firebase.firestore.FieldValue.increment(taskData.points),
                    todayEarnings: firebase.firestore.FieldValue.increment(taskData.points),
                    totalEarnings: firebase.firestore.FieldValue.increment(taskData.points),
                    completedTasks: firebase.firestore.FieldValue.increment(1),
                    taskAttempts: taskAttempts,
                    lastSeen: now
                });
                
                alert(`🎉 ${taskData.points} পয়েন্ট পেয়েছেন!`);
                loadUserData(currentUser.uid);
                
            } catch (error) {
                console.error('Complete task error:', error);
            }
        }

        // ==================== VPN CHECK ====================
        async function checkVPN() {
            // Simple VPN check - you can implement more advanced checks
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                // Add your VPN detection logic here
                return true; // Placeholder
            } catch (error) {
                return false;
            }
        }

        // ==================== WITHDRAWAL SYSTEM ====================
        async function loadWithdrawMethods() {
            try {
                const methodsSnapshot = await db.collection('withdrawMethods').where('enabled', '==', true).orderBy('order', 'asc').get();
                const methodsContainer = document.getElementById('paymentMethods');
                methodsContainer.innerHTML = '';
                
                if (methodsSnapshot.empty) {
                    methodsContainer.innerHTML = '<p class="text-center py-4">কোন পেমেন্ট মেথড পাওয়া যায়নি</p>';
                    return;
                }
                
                methodsSnapshot.forEach(doc => {
                    const method = doc.data();
                    const methodElement = document.createElement('div');
                    methodElement.className = 'withdraw-method bg-gray-800 rounded-lg p-3 text-center cursor-pointer';
                    methodElement.innerHTML = `
                        <i class="fas fa-mobile-alt text-2xl text-blue-400 mb-2"></i>
                        <p class="text-sm font-medium">${method.name}</p>
                        <p class="text-xs text-gray-400">ন্যূনতম: ${method.minAmount} পয়েন্ট</p>
                    `;
                    methodElement.addEventListener('click', () => selectWithdrawMethod(doc.id, method));
                    methodsContainer.appendChild(methodElement);
                });
            } catch (error) {
                console.error('Error loading withdraw methods:', error);
            }
        }

        async function loadWithdrawHistory() {
            try {
                const historySnapshot = await db.collection('withdrawRequests')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('requestedAt', 'desc')
                    .limit(10)
                    .get();
                
                const historyContainer = document.getElementById('withdrawHistory');
                historyContainer.innerHTML = '';
                
                if (historySnapshot.empty) {
                    historyContainer.innerHTML = '<p class="text-center text-sm py-4">আপনার কোন উইথড্র হিস্ট্রি নেই</p>';
                    return;
                }
                
                historySnapshot.forEach(doc => {
                    const request = doc.data();
                    const historyElement = document.createElement('div');
                    historyElement.className = 'bg-gray-800 rounded-lg p-3';
                    historyElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="text-sm">${request.method}</span>
                            <span class="text-sm ${getStatusColor(request.status)}">${request.status}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            Amount: ${request.amount} points • ${request.requestedAt.toDate().toLocaleDateString()}
                        </div>
                    `;
                    historyContainer.appendChild(historyElement);
                });
            } catch (error) {
                console.error('Error loading withdraw history:', error);
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'approved': return 'text-green-400';
                case 'pending': return 'text-yellow-400';
                case 'rejected': return 'text-red-400';
                default: return 'text-gray-400';
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function shareOnTelegram() {
            const referralLink = document.getElementById('referralLink').value;
            const message = `🎯 EarnZone অ্যাপটি ব্যবহার করে পয়েন্ট অর্জন করুন! আমার রেফারেল লিংক: ${referralLink}`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(message)}`, '_blank');
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initTelegramAuth();
            
            // Event listeners
            document.getElementById('dailyBonusBtn').addEventListener('click', claimDailyBonus);
            document.getElementById('claimBonusBtn').addEventListener('click', claimDailyBonus);
            document.getElementById('copyReferralBtn').addEventListener('click', copyReferralLink);
            document.getElementById('withdrawBtn').addEventListener('click', processWithdrawal);
            
            // Navigation
            document.querySelectorAll('.nav-item, .nav-bottom').forEach(item => {
                item.addEventListener('click', function() {
                    const pageName = this.getAttribute('data-page');
                    showPage(pageName);
                });
            });
        });

        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageName).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item, .nav-bottom').forEach(nav => {
                nav.classList.remove('active');
                nav.querySelector('i').classList.remove('text-blue-400');
                nav.querySelector('p').classList.remove('text-blue-400');
            });
            
            // Activate current nav
            const currentNav = document.querySelector(`[data-page="${pageName}"]`);
            currentNav.classList.add('active');
            currentNav.querySelector('i').classList.add('text-blue-400');
            currentNav.querySelector('p').classList.add('text-blue-400');
        }

        console.log("EarnZone অ্যাপ্লিকেশন শুরু হয়েছে...");
    </script>
</body>
</html>